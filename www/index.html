<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFS Explorer</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg: #f3f3f3;
            --sidebar: #e5e5e5;
            --header: #ffffff;
            --accent: #0078d7;
            --text: #000;
            --border: #ccc;
            --hover: #cce8ff;
            --select: #99d1ff;
        }

        * { box-sizing: border-box; user-select: none; outline: none; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; height: 100vh; overflow: hidden; background: var(--bg); color: var(--text); }
        
        .hidden { display: none !important; }

        /* --- LAYOUT --- */
        .explorer-grid { display: flex; flex-direction: column; height: 100%; }

        /* HEADER */
        .header { display: flex; align-items: center; padding: 8px 15px; background: var(--header); border-bottom: 1px solid var(--border); gap: 10px; }
        .nav-btn { border: none; background: transparent; font-size: 16px; padding: 5px 10px; cursor: pointer; color: #555; border-radius: 4px; }
        .nav-btn:hover { background: #eee; }

        .address-bar { flex-grow: 1; display: flex; align-items: center; border: 1px solid #aaa; padding: 4px 10px; background: white; height: 30px; border-radius: 2px; }
        .address-bar input { border: none; width: 100%; font-size: 13px; color: #333; }

        /* USER MENU */
        .user-menu-btn { padding: 5px 10px; border: 1px solid transparent; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 6px; border-radius: 4px; transition: 0.2s; }
        .user-menu-btn:hover { background: #eee; border-color: #ccc; }
        .user-avatar { width: 24px; height: 24px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; font-weight: bold; }

        /* BODY */
        .body-container { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 220px; background: var(--sidebar); border-right: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; }
        .sidebar-btn { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; font-size: 13px; color: #333; gap: 10px; border-left: 3px solid transparent; }
        .sidebar-btn:hover { background: #dcdcdc; }
        .sidebar-btn.active { background: #cce8ff; border-left-color: var(--accent); }
        .sidebar-spacer { flex-grow: 1; }

        /* FILE VIEW */
        #file-view { flex: 1; padding: 10px; overflow-y: auto; background: white; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); grid-auto-rows: 110px; gap: 5px; align-content: start; }

        .file-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border: 1px solid transparent; border-radius: 2px; transition: 0.1s; cursor: default; }
        .file-item:hover { background-color: #e5f3ff; border-color: #cce8ff; }
        .file-item.selected { background-color: #cce8ff; border-color: #99d1ff; }
        
        .file-icon { font-size: 42px; margin-bottom: 5px; }
        .file-name { font-size: 12px; text-align: center; word-wrap: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-width: 100%; }

        /* Drag Drop */
        .drag-over { background: #e6f4ff !important; border: 2px dashed var(--accent) !important; }

        /* FOOTER */
        .footer { background: #f9f9f9; border-top: 1px solid #ddd; padding: 4px 15px; font-size: 11px; color: #666; display: flex; gap: 20px; }

        /* --- MODALS --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; border: 1px solid #999; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; width: 400px; display: flex; flex-direction: column; }
        .modal-header { background: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; }
        .modal-body { padding: 20px; background: #fafafa; font-size: 13px; }
        .modal-footer { padding: 10px 12px; background: #f0f0f0; text-align: right; border-top: 1px solid #e0e0e0; }

        /* Controls */
        input.inp { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; margin-bottom: 10px; font-size: 13px; }
        input.inp:focus { border-color: var(--accent); }
        
        button.btn { padding: 5px 15px; border: 1px solid #adadad; background: #e1e1e1; font-size: 12px; cursor: pointer; min-width: 70px; border-radius: 3px; }
        button.btn:hover { border-color: var(--accent); background: #e5f1fb; }
        button.btn-primary { border-color: #005a9e; background: var(--accent); color: white; }
        button.btn-primary:hover { background: #0063b1; }
        button.btn-danger { border-color: #a00; background: #d00; color: white; }
        button.btn-danger:hover { background: #b00; }
        button.btn-success { border-color: #107c10; background: #107c10; color: white; }
        button.btn-success:hover { background: #0b5a0b; }

        /* CONTEXT MENU */
        #context-menu { position: absolute; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); display: none; z-index: 3000; min-width: 150px; padding: 4px 0; }
        .ctx-item { padding: 6px 15px; cursor: pointer; font-size: 12px; }
        .ctx-item:hover { background: #f0f0f0; }
        .ctx-sep { height: 1px; background: #ddd; margin: 3px 0; }

        /* Login Specific */
        #login-screen { background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1920&q=80') center/cover; display: flex; }
        .login-card { width: 320px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        
        /* Editor */
        #editor-content { width: 700px; height: 450px; border: 1px solid #ccc; padding: 10px; font-family: monospace; resize: none; }
        
        /* User List Table */
        .user-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border: 1px solid #ccc; }
        .user-table th { text-align: left; background: #f0f0f0; padding: 5px; border-bottom: 1px solid #ccc; }
        .user-table td { padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="overlay" style="display: flex;">
        <div class="login-card">
            <h2 style="margin:0 0 20px 0; color:#333;">OFS Login</h2>
            <input type="text" id="login-u" class="inp" placeholder="Username" value="admin">
            <input type="password" id="login-p" class="inp" placeholder="Password" value="admin123">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="login()">Sign In</button>
            <p id="login-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-ui" class="explorer-grid hidden">
        <!-- Header -->
        <div class="header">
            <button class="nav-btn" onclick="goUp()" title="Up">‚¨Ü</button>
            <button class="nav-btn" onclick="refresh()" title="Refresh">‚ü≥</button>
            
            <div class="address-bar">
                <span style="margin-right:5px;">üìÅ</span>
                <input type="text" id="path-input" readonly value="/">
            </div>

            <!-- User Profile -->
            <button class="user-menu-btn" onclick="showSession()">
                <div class="user-avatar" id="avatar-initial">A</div>
                <span id="header-user">admin</span>
                <span>‚ñº</span>
            </button>
        </div>

        <!-- Body -->
        <div class="body-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-btn active" onclick="navTo('/')"><span>üíª</span> This PC</div>
                <div class="sidebar-btn" onclick="navTo('/Downloads')"><span style="color:#0078d7">‚¨áÔ∏è</span> Downloads</div>
                <div class="sidebar-btn" onclick="navTo('/Documents')"><span style="color:#ffa600">üìÑ</span> Documents</div>
                
                <div class="sidebar-spacer"></div>

                <!-- Admin Only Buttons -->
                <div id="admin-sidebar-btn" class="sidebar-btn hidden" onclick="showUserMgr()" style="color:#0078d7; font-weight:bold;">
                    <span>üë•</span> Manage Users
                </div>
                <!-- NEW BUTTON -->
                <div id="add-user-btn" class="sidebar-btn hidden" onclick="showAddUserModal()" style="color:#107c10; font-weight:bold;">
                    <span>‚ûï</span> Add New User
                </div>

                <div class="sidebar-btn" onclick="logout()" style="color:#d00;">
                    <span>üö™</span> Logout
                </div>
            </div>

            <!-- File Grid -->
            <div id="file-view" 
                 ondrop="handleExternalDrop(event)" 
                 ondragover="event.preventDefault()"
                 onclick="deselectAll()">
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <span id="status-count">0 items</span>
            <span style="border-left:1px solid #ccc;"></span>
            <span id="status-role">Role: User</span>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="context-menu">
        <div class="ctx-item" onclick="ctxAction('open')"><b>Open</b></div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="promptCreate('dir')">New folder</div>
        <div class="ctx-item" onclick="promptCreate('file')">New file</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="ctxAction('rename')">Rename</div>
        <div class="ctx-item" onclick="ctxAction('delete')">Delete</div>
        <div class="ctx-sep"></div>
        <div class="ctx-item" onclick="ctxAction('properties')">Properties</div>
    </div>

    <!-- MODALS -->

    <!-- User Manager (Admin) -->
    <div id="modal-users" class="overlay">
        <div class="modal" style="width:500px;">
            <div class="modal-header"><span>User Management</span><button class="nav-btn" onclick="closeModals()">‚úï</button></div>
            <div class="modal-body">
                <strong>All Users:</strong>
                <div style="max-height:250px; overflow-y:auto; border:1px solid #ccc; margin-top:5px;">
                    <table class="user-table">
                        <thead><tr><th>Username</th><th style="width:50px;">Action</th></tr></thead>
                        <tbody id="user-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" style="float:left;" onclick="shutdown()">Shutdown Server</button>
                <button class="btn btn-success" onclick="showAddUserModal()">+ New User</button>
                <button class="btn" onclick="closeModals()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add User Specific Modal -->
    <div id="modal-add-user" class="overlay">
        <div class="modal" style="width:300px;">
            <div class="modal-header"><span>Create New User</span><button class="nav-btn" onclick="closeModals()">‚úï</button></div>
            <div class="modal-body">
                <label>New Username:</label>
                <input id="direct-new-u" class="inp">
                <label>New Password:</label>
                <input id="direct-new-p" class="inp" type="password">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitNewUser()">Create Account</button>
                <button class="btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="modal-input" class="overlay">
        <div class="modal" style="width:300px;">
            <div class="modal-header"><span id="input-title">Action</span></div>
            <div class="modal-body">
                <label>Name:</label>
                <input id="input-val" class="inp">
                <input type="hidden" id="input-type">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitInput()">OK</button>
                <button class="btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="modal-editor" class="overlay">
        <div class="modal" style="width:auto;">
            <div class="modal-header">
                <span id="editor-title">Notepad</span>
                <button class="nav-btn" onclick="closeModals()">‚úï</button>
            </div>
            <div style="padding:0;">
                <textarea id="editor-content"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveFile()">Save</button>
                <button class="btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Properties Modal -->
    <div id="modal-props" class="overlay">
        <div class="modal" style="width:350px;">
            <div class="modal-header"><span>Properties</span><button class="nav-btn" onclick="closeModals()">‚úï</button></div>
            <div class="modal-body" id="props-body"></div>
            <div class="modal-footer"><button class="btn" onclick="closeModals()">OK</button></div>
        </div>
    </div>

    <!-- Session Info -->
    <div id="modal-session" class="overlay">
        <div class="modal" style="width:300px; text-align:center;">
            <div class="modal-header"><span>Account</span><button class="nav-btn" onclick="closeModals()">‚úï</button></div>
            <div class="modal-body">
                <div style="font-size:40px; margin-bottom:10px;">üë§</div>
                <h3 id="sess-u" style="margin:0;">User</h3>
                <p id="sess-r" style="color:#666; margin:5px 0;">Role</p>
                <p style="font-size:10px; color:#aaa; word-break:break-all;" id="sess-id"></p>
            </div>
            <div class="modal-footer" style="text-align:center;">
                <button class="btn btn-danger" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let state = { sid: "", path: "/", user: "", isAdmin: false };
        let ctxTarget = null;
        let currentEditPath = "";
        let dragSource = null;

        // --- API ---
        async function api(op, params = {}) {
            try {
                const res = await fetch('/api', {
                    method: 'POST',
                    body: JSON.stringify({ operation: op, session_id: state.sid, parameters: params })
                });
                return await res.json();
            } catch(e) { return { status: "error", error_message: "Connection Error" }; }
        }

        // --- AUTH ---
        async function login() {
            const u = document.getElementById('login-u').value;
            const p = document.getElementById('login-p').value;
            
            const res = await api("user_login", { username: u, password: p });
            
            if(res.status === "success") {
                state.sid = res.data.session_id;
                state.user = res.data.username;
                state.isAdmin = res.data.is_admin;

                // Update UI
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-ui').classList.remove('hidden');
                
                document.getElementById('header-user').innerText = state.user;
                document.getElementById('avatar-initial').innerText = state.user[0].toUpperCase();
                document.getElementById('status-role').innerText = "Role: " + (state.isAdmin ? "Administrator" : "Standard User");

                if(state.isAdmin) {
                    document.getElementById('admin-sidebar-btn').classList.remove('hidden');
                    document.getElementById('add-user-btn').classList.remove('hidden'); // Show new button
                }

                // Init & Refresh
                await api("dir_create", { path: "/Downloads" });
                await api("dir_create", { path: "/Documents" });
                refresh();
            } else {
                document.getElementById('login-msg').innerText = res.error_message;
            }
        }

        async function logout() {
            await api("user_logout");
            location.reload();
        }

        function showSession() {
            document.getElementById('sess-u').innerText = state.user;
            document.getElementById('sess-r').innerText = state.isAdmin ? "Administrator" : "Standard User";
            document.getElementById('sess-id').innerText = state.sid;
            document.getElementById('modal-session').style.display = 'flex';
        }

        // --- FILE BROWSER ---
        async function refresh() {
            document.getElementById('path-input').value = state.path;
            const view = document.getElementById('file-view');
            view.innerHTML = "";

            const res = await api("list_directory_contents", { path: state.path });
            if(res.status === "success") {
                document.getElementById('status-count').innerText = `${res.data.length} items`;
                
                res.data.sort((a, b) => b.is_directory - a.is_directory);

                res.data.forEach(f => {
                    if(f.name === "/" || f.name === "." || f.name === "..") return;
                    if(state.path === "/" && (f.name === "Downloads" || f.name === "Documents")) return;

                    const el = document.createElement('div');
                    el.className = 'file-item';
                    el.draggable = true;
                    
                    let icon = f.is_directory ? "üìÅ" : "üìÑ";
                    let style = f.is_directory ? "color:#ffd04b" : "color:#aaa";
                    if(f.name.endsWith(".txt")) { icon = "üìù"; style="color:#555"; }

                    el.innerHTML = `<div class="file-icon" style="${style}">${icon}</div><div class="file-name">${f.name}</div>`;
                    
                    el.onclick = (e) => { e.stopPropagation(); deselectAll(); el.classList.add('selected'); };
                    el.ondblclick = () => { f.is_directory ? navTo(f.name) : openFile(f.name); };
                    el.oncontextmenu = (e) => { 
                        e.preventDefault(); e.stopPropagation(); 
                        ctxTarget = f; showContext(e.pageX, e.pageY); 
                    };
                    
                    // Drag & Drop
                    el.ondragstart = (e) => { dragSource = f; e.dataTransfer.effectAllowed = "move"; };
                    if(f.is_directory) {
                        el.ondragover = (e) => { e.preventDefault(); el.classList.add('drag-over'); };
                        el.ondragleave = () => el.classList.remove('drag-over');
                        el.ondrop = (e) => {
                            e.preventDefault(); e.stopPropagation();
                            el.classList.remove('drag-over');
                            if(dragSource) moveFile(dragSource.name, f.name);
                            else handleExternalDrop(e, f.name);
                        };
                    }

                    view.appendChild(el);
                });
            }
        }

        function navTo(name) {
            if(name.startsWith('/')) state.path = name;
            else state.path = (state.path === "/" ? "/" : state.path + "/") + name;
            refresh();
        }
        function goUp() {
            if(state.path === "/") return;
            const p = state.path.split('/'); p.pop();
            state.path = p.join('/') || "/";
            refresh();
        }

        // --- OPERATIONS ---
        async function moveFile(name, dest) {
            if(name === dest) return;
            const pre = state.path === "/" ? "/" : state.path + "/";
            await api("rename_path", { old_path: pre + name, new_path: pre + dest + "/" + name });
            refresh();
        }

        async function handleExternalDrop(e, sub=null) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if(!files.length) return;
            
            for(let i=0; i<files.length; i++) {
                const f = files[i];
                const r = new FileReader();
                r.onload = async (ev) => {
                    let d = state.path;
                    if(sub) d = (d === "/" ? "/" : d + "/") + sub;
                    const path = (d === "/" ? "/" : d + "/") + f.name;
                    await api("create_file_with_content", { path: path, data: ev.target.result });
                    refresh();
                };
                r.readAsText(f);
            }
        }

        // --- EDITOR ---
        async function openFile(name) {
            const p = (state.path === "/" ? "/" : state.path + "/") + name;
            currentEditPath = p;
            const res = await api("file_read", { path: p });
            if(res.status === "success") {
                document.getElementById('editor-content').value = res.data.content;
                document.getElementById('editor-title').innerText = name;
                document.getElementById('modal-editor').style.display = 'flex';
            } else alert("Read Failed");
        }

        async function saveFile() {
            const txt = document.getElementById('editor-content').value;
            await api("remove_file", { path: currentEditPath });
            await api("create_file_with_content", { path: currentEditPath, data: txt });
            closeModals();
        }

        // --- USER MANAGER (ADMIN) ---
        async function showUserMgr() {
            const res = await api("user_list");
            if(res.status === "success") {
                const tb = document.getElementById('user-list-body');
                tb.innerHTML = "";
                res.data.users.forEach(u => {
                    let btn = `<button class="btn btn-danger" onclick="delUser('${u}')" style="padding:2px 8px;">Del</button>`;
                    if(u === 'admin') btn = '<span style="color:#aaa; font-size:11px;">System</span>';
                    tb.innerHTML += `<tr><td>${u}</td><td>${btn}</td></tr>`;
                });
                document.getElementById('modal-users').style.display = 'flex';
            }
        }

        // Show specific Add User Modal
        function showAddUserModal() {
            document.getElementById('direct-new-u').value = "";
            document.getElementById('direct-new-p').value = "";
            document.getElementById('modal-add-user').style.display = 'flex';
            document.getElementById('direct-new-u').focus();
        }

        async function submitNewUser() {
            const u = document.getElementById('direct-new-u').value;
            const p = document.getElementById('direct-new-p').value;
            if(!u || !p) return alert("Enter username and password");
            
            const res = await api("user_create", { username: u, password: p, role: 0 });
            if(res.status === "success") {
                closeModals();
                alert("User created successfully!");
                showUserMgr(); // Optionally open manager to show result
            } else alert(res.error_message);
        }

        async function delUser(u) {
            if(confirm(`Delete user ${u}?`)) {
                await api("user_delete", { username: u });
                showUserMgr();
            }
        }
        
        async function shutdown() {
            if(confirm("Shutdown server?")) {
                await api("fs_shutdown");
                document.body.innerHTML = "<h1 style='text-align:center; margin-top:20%; color:#555'>Server Offline</h1>";
            }
        }

        // --- MODALS & CTX ---
        function closeModals() { document.querySelectorAll('.overlay').forEach(e => e.style.display = 'none'); }
        
        function showContext(x, y) {
            const m = document.getElementById('context-menu');
            m.style.display = 'block';
            if(x + 150 > window.innerWidth) x -= 150;
            m.style.left = x + 'px'; m.style.top = y + 'px';
        }
        
        document.onclick = () => document.getElementById('context-menu').style.display = 'none';
        document.getElementById('file-view').oncontextmenu = (e) => {
            if(e.target.id === 'file-view') { e.preventDefault(); ctxTarget = null; showContext(e.pageX, e.pageY); }
        };

        function deselectAll() { document.querySelectorAll('.file-item').forEach(e => e.classList.remove('selected')); }

        async function ctxAction(act) {
            const p = (state.path === "/" ? "/" : state.path + "/") + (ctxTarget ? ctxTarget.name : "");
            if(act === 'open') { if(ctxTarget && ctxTarget.is_directory) navTo(ctxTarget.name); else if(ctxTarget) openFile(ctxTarget.name); }
            else if(act === 'rename') promptCreate('rename', ctxTarget.name);
            else if(act === 'delete') { if(confirm("Delete?")) { await api(ctxTarget.is_directory?"remove_directory":"remove_file", {path:p}); refresh(); } }
            else if(act === 'properties' && ctxTarget) {
                const res = await api("get_path_metadata", {path:p});
                if(res.status === "success") {
                    const d = res.data;
                    document.getElementById('props-body').innerHTML = `
                        <div style="text-align:center; margin-bottom:10px"><div style="font-size:40px">${d.is_directory?'üìÅ':'üìÑ'}</div><b>${d.name}</b></div>
                        <p><b>Size:</b> ${d.size} bytes</p>
                        <p><b>Owner:</b> ${d.owner_id}</p>
                        <p><b>Created:</b> ${new Date(d.created*1000).toLocaleDateString()}</p>
                    `;
                    document.getElementById('modal-props').style.display = 'flex';
                }
            }
        }

        function promptCreate(type, val="") {
            document.getElementById('input-title').innerText = type === 'rename' ? "Rename" : "Create " + (type==='dir'?"Folder":"File");
            document.getElementById('input-type').value = type;
            document.getElementById('input-val').value = val;
            document.getElementById('modal-input').style.display = 'flex';
            document.getElementById('input-val').focus();
        }

        async function submitInput() {
            const t = document.getElementById('input-type').value;
            const v = document.getElementById('input-val').value;
            if(!v) return;
            const pre = state.path === "/" ? "/" : state.path + "/";
            
            if(t === 'dir') await api("dir_create", { path: pre + v });
            else if(t === 'file') await api("create_file_with_content", { path: pre + v, data: "" });
            else if(t === 'rename') {
                const old = pre + ctxTarget.name;
                await api("rename_path", { old_path: old, new_path: pre + v });
            }
            closeModals();
            refresh();
        }
    </script>
</body>
</html>